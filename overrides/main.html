{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}
  <!-- Typography & Icons -->
  <link rel="preconnect" href="https://gs.jurieo.com/gemini/fonts-googleapis">
  <link rel="preconnect" href="https://gs.jurieo.com/gemini/fonts-gstatic" crossorigin>
  <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@400;700&family=Syncopate:wght@700;800&display=swap" rel="stylesheet">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* --- 1. CORE THEME VARIABLES --- */
    :root {
      --klein-blue: #002FA7;
      --klein-blue-hover: #0042e6;
      --klein-light: #4D8BFF; /* For Dark Mode */
      
      /* App-like Dimensions */
      --header-height: 0px; /* We hide the default header */
      --capsule-height: 48px;
      
      /* Glass Vars */
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-bg-hover: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(0, 0, 0, 0.08);
      --glass-blur: blur(20px);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
      
      /* Fonts */
      --md-text-font: "Inter", sans-serif;
      --md-code-font: "JetBrains Mono", monospace;
    }

    /* LIGHT MODE */
    [data-md-color-scheme="default"] {
      --bg-color: #F2F2F7;
      --text-primary: #111111;
      --text-secondary: #666666;
      --accent-color: var(--klein-blue);
      --surface-color: rgba(255, 255, 255, 0.5);
    }

    /* DARK MODE */
    [data-md-color-scheme="slate"] {
      --bg-color: #050505;
      --text-primary: #ffffff;
      --text-secondary: #aaaaaa;
      --accent-color: var(--klein-light);
      --surface-color: rgba(30, 30, 30, 0.5);
      
      --glass-bg: rgba(20, 20, 20, 0.65);
      --glass-bg-hover: rgba(40, 40, 40, 0.85);
      --glass-border: rgba(255, 255, 255, 0.12);
    }

    /* --- 2. GLOBAL RESET & LAYOUT --- */
    body {
      background-color: var(--bg-color);
      transition: background-color 0.5s ease;
    }
    
    /* Hide Default Elements */
    .md-header, .md-tabs, .md-footer { display: none !important; }
    
    /* Main Layout Adjustments */
    .md-container { padding-top: 0 !important; }
    .md-main__inner {
      padding-top: 6rem; /* Space for Capsules */
      padding-bottom: 6rem; /* Space for Footer */
      max-width: 94vw;
      display: flex;
      justify-content: center;
    }

    /* --- 3. CUSTOM CAPSULE NAVIGATION --- */
    .nav-layer {
      position: fixed; top: 1.5rem; left: 0; width: 100%;
      display: flex; justify-content: center; align-items: flex-start; gap: 1rem;
      z-index: 100; pointer-events: none;
    }

    .capsule {
      pointer-events: auto;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 9999px;
      height: var(--capsule-height);
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--glass-shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-primary);
    }
    .capsule:hover {
      background: var(--glass-bg-hover);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
    }

    /* --- CAPSULE 1: MENU (Logo | Section) --- */
    .capsule-menu {
      padding: 0 1.25rem;
      position: relative; /* For dropdown positioning */
      gap: 1rem;
      min-width: 200px;
      cursor: default;
    }

    .menu-brand {
      display: flex; align-items: center; gap: 0.5rem;
      font-family: 'Syncopate', sans-serif; font-weight: 700; font-size: 0.75rem;
      color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em;
      text-decoration: none;
    }
    
    .menu-divider { width: 1px; height: 16px; background: var(--text-secondary); opacity: 0.3; }

    .menu-current {
      display: flex; align-items: center; gap: 0.5rem;
      font-size: 0.8rem; font-weight: 600; color: var(--accent-color);
      cursor: pointer;
    }
    
    /* Hover Dropdown Logic */
    .menu-dropdown {
      position: absolute;
      top: calc(100% + 8px); left: 0;
      width: 240px;
      background: var(--glass-bg);
      backdrop-filter: blur(30px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 0.5rem;
      display: flex; flex-direction: column; gap: 2px;
      opacity: 0; visibility: hidden; transform: translateY(-10px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    }
    
    .capsule-menu:hover .menu-dropdown {
      opacity: 1; visibility: visible; transform: translateY(0);
    }

    .dropdown-item {
      padding: 0.75rem 1rem;
      border-radius: 10px;
      text-decoration: none;
      font-size: 0.85rem; font-weight: 500;
      color: var(--text-primary);
      display: flex; justify-content: space-between; align-items: center;
      transition: background 0.2s;
    }
    .dropdown-item:hover { background: rgba(125,125,125,0.1); }
    .dropdown-item.active { background: var(--accent-color); color: white; }

    /* --- CAPSULE 2: SEARCH --- */
    .capsule-search {
      width: var(--capsule-height);
      cursor: pointer;
    }
    .capsule-search label {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }

    /* --- CAPSULE 3: THEME --- */
    .capsule-theme {
      width: var(--capsule-height);
      cursor: pointer;
      position: relative;
    }
    /* Hidden checkboxes for MkDocs logic */
    .theme-toggle-input { display: none; }

    /* --- 4. SIDEBAR & TOC OVERRIDES --- */
    
    /* Ensure sidebars are visible above background */
    .md-sidebar {
      z-index: 10 !important;
    }

    /* Main Navigation Sidebar (Left) */
    .md-sidebar--primary {
      top: 7rem !important; /* Push down */
      height: calc(100vh - 8rem) !important;
      background: transparent !important;
    }
    .md-sidebar--primary .md-sidebar__scrollwrap {
      background: var(--surface-color);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      padding: 1rem;
      margin-right: 10px;
    }

    /* Table of Contents Sidebar (Right) */
    .md-sidebar--secondary {
      top: 7rem !important;
      height: calc(100vh - 8rem) !important;
      background: transparent !important;
    }
    
    .md-sidebar--secondary .md-sidebar__scrollwrap {
      background: var(--surface-color);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      padding: 1rem;
      margin-left: 10px;
    }
    
    /* Link Styling */
    .md-nav__link {
      color: var(--text-secondary);
      transition: color 0.2s;
    }
    .md-nav__item .md-nav__link--active {
      color: var(--accent-color);
      font-weight: 700;
    }

    /* --- 5. CONTENT AREA --- */
    .md-content {
      background: var(--surface-color);
      backdrop-filter: blur(30px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 2.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.02);
      /* Ensure it doesn't overlap the fixed header area */
      margin-top: 0; 
      width: 100%;
    }
    
    /* Typography Overrides */
    h1 { 
      font-family: 'Syncopate', sans-serif; 
      font-weight: 800; 
      letter-spacing: -0.02em; 
      text-transform: uppercase;
      margin-bottom: 1.5rem;
    }
    
    /* Code Blocks */
    .md-typeset pre > code {
      font-family: 'JetBrains Mono', monospace;
      background: #0d0d0d !important;
      border: 1px solid rgba(255,255,255,0.1);
    }
    /* Copy Button */
    .md-clipboard {
      color: rgba(255,255,255,0.6);
      transition: all 0.2s;
    }
    .md-clipboard:hover { color: white; background: var(--accent-color); }

    /* --- 6. CUSTOM FOOTER --- */
    .custom-footer {
      position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 9999px;
      padding: 0.75rem 2rem;
      display: flex; align-items: center; gap: 1.5rem;
      z-index: 90;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    .footer-text { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); }
    .footer-link { font-family: 'Syncopate', sans-serif; font-weight: 700; color: var(--text-primary); text-decoration: none; }
    .footer-up { 
      display: flex; align-items: center; justify-content: center;
      width: 24px; height: 24px; border-radius: 50%; 
      background: var(--text-primary); color: var(--bg-color);
      cursor: pointer; transition: transform 0.2s;
    }
    .footer-up:hover { transform: translateY(-2px); }

    /* --- 7. AURORA ANIMATION --- */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
      overflow: hidden; pointer-events: none;
    }
    .aurora-blob {
      position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.4;
      animation: float 20s infinite ease-in-out;
    }
    .blob-1 { top: -20%; right: -10%; width: 60vw; height: 60vw; background: var(--accent-color); }
    .blob-2 { bottom: -20%; left: -10%; width: 50vw; height: 50vw; background: #00d2ff; animation-delay: -5s; }
    
    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(-20px, 20px); }
    }

    /* Mobile Responsive */
    @media screen and (max-width: 768px) {
      .nav-layer { justify-content: space-between; padding: 0 1rem; }
      .capsule-menu { min-width: auto; padding: 0 1rem; }
      .menu-divider, .menu-current { display: none; } /* Simplify logo on mobile */
      .md-sidebar { display: none; } /* Standard MkDocs handles mobile nav differently */
      .md-main__inner { padding-top: 5rem; padding-bottom: 6rem; max-width: 90vw; }
      .custom-footer { width: 90%; justify-content: space-between; }
    }
  </style>
{% endblock %}

{% block header %}
  <!-- NAVIGATION CAPSULES -->
  <div class="nav-layer">
    
    <!-- 1. MENU CAPSULE -->
    <div class="capsule capsule-menu">
      <a href="{{ nav.url | url }}" class="menu-brand">
        {% if config.theme.logo %}
          <img src="{{ config.theme.logo | url }}" alt="Logo" style="height: 18px; width: auto;">
        {% endif %}
        <span>{{ config.site_name }}</span>
      </a>
      
      <div class="menu-divider"></div>
      
      <!-- Logic to find current Top-Level Section -->
      {% set current_section_title = "Home" %}
      {% for nav_item in nav %}
        {% if nav_item.active %}
          {% set current_section_title = nav_item.title %}
        {% else %}
          {% if nav_item.children %}
            {% for child in nav_item.children %}
               {% if child.active or (child.children and child in page.ancestors) %}
                  {% set current_section_title = nav_item.title %}
               {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endfor %}

      <div class="menu-current">
        <span>{{ current_section_title }}</span>
        <!-- Right Arrow Icon -->
        <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
      </div>

      <!-- Dropdown Menu -->
      <div class="menu-dropdown">
        {% for nav_item in nav %}
          <a href="{{ nav_item.url | url if nav_item.url else '#' }}" class="dropdown-item {% if nav_item.title == current_section_title %}active{% endif %}">
            <span>{{ nav_item.title }}</span>
            {% if nav_item.title == current_section_title %}
              <i data-lucide="check" style="width: 14px;"></i>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- 2. SEARCH CAPSULE -->
    <div class="capsule capsule-search" title="Search">
      <label for="__search">
        <i data-lucide="search" style="width: 18px; height: 18px;"></i>
      </label>
    </div>

    <!-- 3. THEME CAPSULE -->
    <!-- 
       MkDocs Material Logic:
       Standard config has 3 palettes: Auto (1), Light (2), Dark (3).
       We render ONE button that triggers the 'next' one in the cycle.
    -->
    <div class="capsule capsule-theme" onclick="cycleTheme()" title="Switch Theme">
      <!-- Icon changes based on active palette via CSS/JS -->
      <div id="theme-icon-container" style="display: flex; align-items: center;">
         <!-- Icons injected by JS based on state -->
         <i data-lucide="monitor" style="width: 18px;"></i> 
      </div>
    </div>
  </div>

  <!-- Standard Hidden Header for MkDocs functionality (Search Modal, etc) -->
  <div class="md-header" data-md-component="header"></div>
{% endblock %}

{% block footer %}
  <!-- CUSTOM GLASS FOOTER -->
  <footer class="custom-footer">
    <!-- FIX: Using JS to set date to avoid BlogPlugin strict date filter error -->
    <div class="footer-text">&copy; <span id="year-display">2024</span> {{ config.site_author }}</div>
    <div class="menu-divider" style="height: 12px;"></div>
    <a href="{{ nav.url | url }}" class="footer-link">MQ</a>
    <div class="footer-up" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
      <i data-lucide="arrow-up" style="width: 14px;"></i>
    </div>
  </footer>
{% endblock %}

{% block announce %}
  <!-- Aurora Background -->
  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
    <div class="aurora-blob blob-2"></div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // Set Footer Year safely
    document.getElementById('year-display').textContent = new Date().getFullYear();

    // --- THEME TOGGLE LOGIC ---
    // We assume 3 palettes in mkdocs.yml: 0:Auto, 1:Light, 2:Dark
    const palettes = ['auto', 'light', 'dark'];
    const icons = {
      'auto': 'monitor',
      'light': 'sun',
      'dark': 'moon'
    };

    function updateThemeIcon() {
      // Find which palette input is checked
      const inputs = document.querySelectorAll('input[name="__palette"]');
      let activeIndex = 0;
      inputs.forEach((input, index) => {
        if (input.checked) activeIndex = index;
      });

      // Update the icon in our custom capsule
      const currentMode = palettes[activeIndex] || 'auto';
      const container = document.getElementById('theme-icon-container');
      container.innerHTML = `<i data-lucide="${icons[currentMode]}" style="width: 18px;"></i>`;
      lucide.createIcons();
    }

    function cycleTheme() {
      const inputs = document.querySelectorAll('input[name="__palette"]');
      if(inputs.length === 0) return;

      // Find current index
      let currentIndex = 0;
      inputs.forEach((input, idx) => { if(input.checked) currentIndex = idx; });

      // Calculate next index
      let nextIndex = (currentIndex + 1) % inputs.length;
      
      // Click the hidden MkDocs label to trigger the switch
      const nextId = inputs[nextIndex].id; // e.g., __palette_2
      const label = document.querySelector(`label[for="${nextId}"]`);
      
      if(label) label.click();
      else if (inputs[nextIndex]) inputs[nextIndex].click(); // Fallback
      
      // Slight delay to allow DOM update then refresh icon
      setTimeout(updateThemeIcon, 50);
    }

    // Run on load
    document.addEventListener('DOMContentLoaded', () => {
      updateThemeIcon();
      
      // Listen for changes (in case system theme changes automatically)
      const inputs = document.querySelectorAll('input[name="__palette"]');
      inputs.forEach(input => {
         input.addEventListener('change', updateThemeIcon);
      });
    });
  </script>
{% endblock %}
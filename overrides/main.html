{% extends "base.html" %}

{% block extrahead %}
  {{ super() }}
  <!-- Typography & Icons -->
  <link rel="preconnect" href="https://gs.jurieo.com/gemini/fonts-googleapis">
  <link rel="preconnect" href="https://gs.jurieo.com/gemini/fonts-gstatic" crossorigin>
  <link href="https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@400;700&family=Syncopate:wght@700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    /* --- 1. CORE VARIABLES --- */
    :root {
      --klein-blue: #002FA7;
      --klein-light: #4D8BFF;
      
      /* Navigation Dimensions */
      --nav-height: 80px;
      --capsule-height: 44px;
      
      /* Glass Styling */
      --glass-bg: rgba(255, 255, 255, 0.75);
      --glass-bg-hover: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(0, 0, 0, 0.06);
      --glass-blur: blur(20px);
      --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
      
      /* Fonts */
      --md-text-font: "Inter", sans-serif;
      --md-code-font: "JetBrains Mono", monospace;
    }

    /* DARK MODE OVERRIDES */
    [data-md-color-scheme="slate"] {
      --glass-bg: rgba(20, 20, 20, 0.75);
      --glass-bg-hover: rgba(40, 40, 40, 0.95);
      --glass-border: rgba(255, 255, 255, 0.1);
      --glass-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* --- 2. LAYOUT RESET --- */
    /* Hide default header VISUALLY but keep functionality for search/theme */
    .md-header {
      opacity: 0;
      height: 0;
      pointer-events: none;
      position: absolute;
      z-index: -1;
    }
    .md-tabs { display: none !important; }

    /* Push content down to accommodate fixed capsules */
    .md-main__inner {
      padding-top: var(--nav-height);
    }

    /* --- 3. FLOATING CAPSULE NAVIGATION --- */
    .nav-layer {
      position: fixed;
      top: 0; left: 0; width: 100%; height: var(--nav-height);
      display: flex; justify-content: center; align-items: center; gap: 12px;
      z-index: 100; pointer-events: none; /* Allow clicks through empty space */
      transition: background 0.3s;
    }

    .capsule {
      pointer-events: auto;
      height: var(--capsule-height);
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 9999px;
      box-shadow: var(--glass-shadow);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      color: var(--md-default-fg-color);
    }
    .capsule:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      background: var(--glass-bg-hover);
    }

    /* --- MENU CAPSULE --- */
    .capsule-menu {
      padding: 0 1.5rem;
      gap: 1rem;
      position: relative;
      cursor: default;
    }
    
    .menu-brand {
      font-family: 'Syncopate', sans-serif;
      font-weight: 800;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      text-decoration: none;
      color: var(--md-default-fg-color);
    }
    
    .menu-sep { width: 1px; height: 16px; background: currentColor; opacity: 0.2; }
    
    .menu-section {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--md-accent-fg-color);
      display: flex; align-items: center; gap: 6px;
      cursor: pointer;
    }

    /* DROPDOWN - Right Aligned */
    .menu-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0; /* Aligns to the right side of the capsule */
      min-width: 220px;
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 6px;
      display: flex; flex-direction: column; gap: 2px;
      
      /* Animation */
      opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.98);
      transform-origin: top right;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    .capsule-menu:hover .menu-dropdown {
      opacity: 1; visibility: visible; transform: translateY(0) scale(1);
    }
    
    .dropdown-link {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--md-default-fg-color);
      text-decoration: none;
      display: flex; justify-content: space-between; align-items: center;
      transition: background 0.1s;
    }
    .dropdown-link:hover { background: rgba(127, 127, 127, 0.1); }
    .dropdown-link.active { color: var(--md-accent-fg-color); background: rgba(127, 127, 127, 0.05); }

    /* --- ICON CAPSULES --- */
    .capsule-icon {
      width: var(--capsule-height);
      cursor: pointer;
      position: relative;
    }
    .capsule-icon label {
      cursor: pointer;
      width: 100%; height: 100%;
      display: flex; justify-content: center; align-items: center;
    }

    /* --- 4. SIDEBAR & CONTENT FIXES --- */
    /* We do NOT position:fixed the sidebar. We let MkDocs handle the grid. */
    /* We just style the scrollwrap to look like glass. */
    
    .md-sidebar__scrollwrap {
      background: var(--glass-bg); /* Use semi-transparent background */
      backdrop-filter: blur(12px); /* Add blur */
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      margin: 0.5rem;
      padding: 0.5rem;
    }
    
    /* Ensure Toc links are visible */
    .md-nav__link { opacity: 0.7; transition: opacity 0.2s; }
    .md-nav__link:hover { opacity: 1; }
    .md-nav__link--active { opacity: 1; font-weight: 700; color: var(--md-accent-fg-color) !important; }

    /* Content Card */
    .md-content {
      background: transparent;
    }
    /* Wrap the actual article content in a glass card if desired, or leave transparent */
    article.md-content__inner {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 3rem;
      margin-bottom: 2rem;
    }

    /* --- 5. FOOTER (DesktopRenamer Style) --- */
    .dr-footer {
      width: 100%;
      padding: 3rem 2rem;
      border-top: 1px solid var(--glass-border);
      background: var(--md-default-bg-color); /* Match body bg */
      display: flex; flex-direction: column; gap: 2rem;
      position: relative; z-index: 10;
    }
    .dr-footer-content {
      max-width: 1200px; margin: 0 auto; width: 100%;
      display: flex; flex-direction: column; md:flex-row; justify-content: space-between; align-items: center;
      gap: 1.5rem;
    }
    
    @media (min-width: 768px) {
      .dr-footer-content { flex-direction: row; }
    }

    .footer-copy { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--md-default-fg-color); opacity: 0.6; }
    
    .footer-brand { 
      font-family: 'Syncopate', sans-serif; font-weight: 900; font-size: 1.5rem; 
      color: var(--md-default-fg-color); opacity: 0.2; text-decoration: none; transition: opacity 0.3s;
    }
    .footer-brand:hover { opacity: 1; color: var(--md-accent-fg-color); }
    
    .footer-up {
      width: 40px; height: 40px; border-radius: 50%;
      border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.3s;
      color: var(--md-default-fg-color);
    }
    .footer-up:hover {
      background: var(--md-accent-fg-color);
      color: white; border-color: transparent;
    }

    /* --- 6. BACKGROUND --- */
    .aurora-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
      pointer-events: none; overflow: hidden;
    }
    .aurora-blob {
      position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.4;
    }
    .blob-1 { top: -20%; right: -20%; width: 60vw; height: 60vw; background: var(--md-accent-fg-color); }
    
  </style>
{% endblock %}

{% block header %}
  <!-- 1. CUSTOM NAVIGATION LAYER -->
  <div class="nav-layer">
    
    <!-- MENU CAPSULE -->
    <div class="capsule capsule-menu">
      <!-- Logo -->
      <a href="{{ nav.url | url }}" class="menu-brand">
        {% if config.theme.logo %}
          <img src="{{ config.theme.logo | url }}" style="height:16px; vertical-align:middle; margin-right:4px;">
        {% endif %}
        {{ config.site_name }}
      </a>

      <div class="menu-sep"></div>

      <!-- Current Section Logic -->
      {% set current_title = "Menu" %}
      <!-- Simple Jinja loop to find active top-level item -->
      {% for nav_item in nav %}
        {% if nav_item.active %}
          {% set current_title = nav_item.title %}
        {% else %}
          {% if nav_item.children %}
             {% for child in nav_item.children %}
                {% if child.active or (child.children and child in page.ancestors) %}
                   {% set current_title = nav_item.title %}
                {% endif %}
             {% endfor %}
          {% endif %}
        {% endif %}
      {% endfor %}

      <!-- Section Trigger -->
      <div class="menu-section">
        {{ current_title }}
        <i data-lucide="chevron-right" style="width:14px;"></i>
      </div>

      <!-- Dropdown -->
      <div class="menu-dropdown">
        {% for nav_item in nav %}
          <a href="{{ nav_item.url | url if nav_item.url else '#' }}" class="dropdown-link {% if nav_item.title == current_title %}active{% endif %}">
            {{ nav_item.title }}
            {% if nav_item.title == current_title %}
              <i data-lucide="check" style="width:14px;"></i>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- SEARCH CAPSULE -->
    <div class="capsule capsule-icon" title="Search">
      <!-- Direct label to MkDocs standard input id -->
      <label for="__search">
        <i data-lucide="search" style="width:18px;"></i>
      </label>
    </div>

    <!-- THEME CAPSULE -->
    <div class="capsule capsule-icon" title="Switch Theme" onclick="toggleTheme()">
      <div id="theme-icon-box" style="display:flex; align-items:center; justify-content:center;">
         <i data-lucide="monitor" style="width:18px;"></i>
      </div>
    </div>

  </div>

  <!-- 2. KEEP STANDARD HEADER (HIDDEN) -->
  <!-- This preserves the DOM elements for search and palette inputs -->
  {{ super() }}
{% endblock %}

{% block footer %}
  <!-- 3. DESKTOP RENAMER STYLE FOOTER -->
  <footer class="dr-footer">
    <div class="dr-footer-content">
      
      <!-- Copyright -->
      <div class="footer-copy">
        &copy; <span id="year-target">2024</span> {{ config.site_author }}
      </div>

      <!-- Brand/Logo Center -->
      <a href="{{ nav.url | url }}" class="footer-brand">MQ</a>

      <!-- Back to Top -->
      <button class="footer-up" onclick="window.scrollTo({top:0, behavior:'smooth'})" aria-label="Back to Top">
        <i data-lucide="arrow-up" style="width:18px;"></i>
      </button>

    </div>
  </footer>
{% endblock %}

{% block announce %}
  <div class="aurora-bg">
    <div class="aurora-blob blob-1"></div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // 1. Icon Init
    lucide.createIcons();

    // 2. Set Footer Year
    const yearTarget = document.getElementById('year-target');
    if(yearTarget) yearTarget.innerText = new Date().getFullYear();

    // 3. Theme Toggle Logic
    const themeIconBox = document.getElementById('theme-icon-box');
    const icons = {
      'auto': 'monitor',
      'default': 'sun', /* mkdocs 'default' scheme is light */
      'slate': 'moon'   /* mkdocs 'slate' scheme is dark */
    };

    function updateThemeIcon() {
      // MkDocs stores scheme in local storage or on body data attribute
      const currentScheme = document.body.getAttribute('data-md-color-scheme') || 'default';
      const pref = localStorage.getItem(__prefix('palette', 'color-scheme')) || 'auto'; 
      
      // We essentially just want to show what's active. 
      // MkDocs cycles: default -> slate -> default (if only 2 defined)
      // Or if auto is defined: auto -> default -> slate
      
      let iconName = icons[currentScheme] || 'monitor';
      // If we can detect 'preference' is auto, show monitor
      // However, just showing current visual state (Sun/Moon) is usually safer
      
      if (themeIconBox) {
        themeIconBox.innerHTML = `<i data-lucide="${iconName}" style="width:18px;"></i>`;
        lucide.createIcons();
      }
    }

    function toggleTheme() {
      // Simulate click on the hidden palette input
      const inputs = document.querySelectorAll('input[name="__palette"]');
      if (!inputs.length) return;
      
      // Find current checked
      let idx = 0;
      inputs.forEach((inp, i) => { if (inp.checked) idx = i; });
      
      // Next
      let next = (idx + 1) % inputs.length;
      
      // Click the label associated with the next input
      const id = inputs[next].id;
      const label = document.querySelector(`label[for="${id}"]`);
      if (label) label.click();
      
      setTimeout(updateThemeIcon, 100);
    }

    // Helper to get mkdocs prefix if needed, usually empty or calculated
    function __prefix(key, value) { return key + (value ? "$" + value : "") }

    // Init
    document.addEventListener('DOMContentLoaded', updateThemeIcon);
    
    // Observer for body attribute changes (MkDocs changes data-md-color-scheme)
    const observer = new MutationObserver(updateThemeIcon);
    observer.observe(document.body, { attributes: true, attributeFilter: ['data-md-color-scheme'] });
  </script>
{% endblock %}